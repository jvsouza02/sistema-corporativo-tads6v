<!DOCTYPE html>
<html lang="pt-BR">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>BarberPro - Histórico de Atendimento</title>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-icons/1.11.3/font/bootstrap-icons.min.css"
    rel="stylesheet">
  <link rel="stylesheet" href="styles/form_barbearia.css">
  <link rel="stylesheet" href="styles/historico_atendimento.css">
</head>

<body>
  <nav class="navbar navbar-expand-lg navbar-dark custom-navbar">
    <div class="container">
      <a class="home navbar-brand" href="gerenciar_barbearia.html">
        <i class="fas fa-cut"></i> BarberPro
      </a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navbarNav">
        <ul class="navbar-nav ms-auto">
          <li class="nav-item">
            <a class="nav-link" style="cursor: pointer;" onclick="logout()">
              <i class="fas fa-sign-out-alt me-1"></i>Deslogar
            </a>
          </li>
        </ul>
      </div>
    </div>
  </nav>

  <div class="container mt-4">
    <h2 class="mb-4">Histórico de Atendimento</h2>
    <div id="infoProfissional" class="alert alert-info d-none"></div>

    <div class="card mb-4">
      <div class="card-body">
        <h5 class="card-title mb-3">Registrar Atendimento</h5>

        <form id="formAtendimento">
          <div class="row g-3">

            <div class="col-md-4">
              <label class="form-label">Serviço</label>
              <select id="servico" class="form-select" required>
                <option value="">Selecione...</option>
                <option value="Corte Social">Corte Social</option>
                <option value="Corte Navalhado">Corte Navalhado</option>
                <option value="Corte Degradê">Corte Degradê</option>
                <option value="Barba">Barba</option>
                <option value="Sobrancelha">Sobrancelha</option>
              </select>
            </div>

            <div class="col-md-4">
              <label class="form-label">Produto Utilizado</label>
              <select id="produto" class="form-select">
                <option value="Nenhum">Nenhum</option>
                <option value="Shampoo">Shampoo</option>
                <option value="Pomada">Pomada</option>
                <option value="Gel">Gel</option>
                <option value="Tônico">Tônico</option>
              </select>
            </div>

            <div class="col-md-4">
              <label class="form-label">Valor Total</label>
              <input id="valorTotal" type="text" class="form-control" disabled value="R$ 0,00">
            </div>

            <div class="col-md-12">
              <label class="form-label">Comentário</label>
              <input type="text" id="comentario" class="form-control" placeholder="Observações..." required>
            </div>

            <div class="col-md-12 d-flex justify-content-end">
              <button class="btn btn-primary" type="submit">Registrar Atendimento</button>
            </div>

          </div>
        </form>

      </div>
    </div>

    <div class="card">
      <div class="card-body">
        <h5 class="card-title mb-3">Atendimentos</h5>
        <div id="listaAtendimentos"></div>
      </div>
    </div>

    <div class="modal fade" id="modalEditar" tabindex="-1">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Editar Comentário</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <form id="formEditar">
              <input type="hidden" id="editarId">
              <div class="mb-3">
                <label for="editarComentario" class="form-label">Comentário</label>
                <textarea class="form-control" id="editarComentario" name="comentario" rows="3" required></textarea>
              </div>
            </form>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
            <button type="button" class="btn btn-primary" onclick="salvarEdicao()">Salvar Alterações</button>
          </div>
        </div>
      </div>
    </div>

    <div class="modal fade" id="modalConfirmar" tabindex="-1">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Confirmar Remoção</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <p id="mensagemConfirmacao">Tem certeza que deseja remover este comentário?</p>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
            <button type="button" class="btn btn-danger" id="btnConfirmarRemocao">Remover</button>
          </div>
        </div>
      </div>
    </div>

    <!-- <footer class="custom-footer mt-5">
    <div class="container">
      <div class="row">
        <div class="col-md-6">
          <h5><i class="fas fa-cut"></i> BarberPro</h5>
          <p>Sistema de gerenciamento para barbearias.</p>
        </div>
        <div class="col-md-6 text-md-end">
          <p>&copy; 2025 BarberPro. Todos os direitos reservados.</p>
        </div>
      </div>
    </div>
  </footer> -->

    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/js/all.min.js"></script>

    <script>
      const usuario = JSON.parse(localStorage.getItem("usuario"));
      const idBarbearia = usuario["id_barbearia"];

      const precos = {
        servicos: {
          "Corte Social": 30,
          "Corte Navalhado": 35,
          "Corte Degradê": 40,
          "Barba": 25,
          "Sobrancelha": 15
        },
        produtos: {
          "Nenhum": 0,
          "Shampoo": 10,
          "Pomada": 12,
          "Gel": 8,
          "Tônico": 20
        }
      };

      function atualizarValor() {
        const servico = document.getElementById("servico").value;
        const produto = document.getElementById("produto").value;

        const total = (precos.servicos[servico] || 0) + (precos.produtos[produto] || 0);
        document.getElementById("valorTotal").value = `R$ ${total.toFixed(2)}`;

        return total;
      }

      document.getElementById("servico").addEventListener("change", atualizarValor);
      document.getElementById("produto").addEventListener("change", atualizarValor);

      document.getElementById("formAtendimento").addEventListener("submit", function (e) {
        e.preventDefault();

        const servico = document.getElementById("servico").value;
        const produto = document.getElementById("produto").value;
        const comentario = document.getElementById("comentario").value;
        const valor = atualizarValor();

        if (typeof valor === "string") valor = valor.replace(",", ".");

        if (!servico) return alert("Selecione um serviço!");


        const texto = `${servico}|${produto}|${valor}|${comentario}`;

        fetch("http://127.0.0.1:8000/observacoes", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            comentario: comentario,
            servico: servico,
            produto: produto,
            valor_total: (() => {
              const v = parseFloat(valor);
              return Number.isFinite(v) ? v : null;
            })(),
            id_barbearia: idBarbearia
          })
        })
          .then(r => r.json())
          .then(() => {
            carregarComentarios();
            document.getElementById("formAtendimento").reset();
            document.getElementById("valorTotal").value = "R$ 0,00";
          });
      });

      function carregarComentarios() {
        fetch(`http://127.0.0.1:8000/observacoes/${idBarbearia}`)
          .then(r => r.json())
          .then(data => {
            console.log(data);
            const lista = document.getElementById("listaAtendimentos");
            lista.innerHTML = "";

            if (data.length === 0) {
              lista.innerHTML = `
              <div class="text-center text-muted py-4">
                <i class="bi bi-inbox display-4"></i>
                <p>Nenhum atendimento registrado</p>
              </div>
            `;
              return;
            }

            data.forEach(at => {
              const item = document.createElement("div");

              item.innerHTML = `
                <div class="card shadow-sm mb-3 atendimento-card">
                  <div class="card-body p-3">
                    <div class="d-flex justify-content-between align-items-start">
                      <div class="info">
                        <div class="mb-1">
                          <span class="badge bg-primary me-1 tag-servico">${at.servico ?? ""}</span>
                          <span class="badge bg-secondary me-1 tag-produto">${at.produto ?? ""}</span>
                          <span class="badge bg-light text-dark tag-valor">R$ ${at.valor_total}</span>
                        </div>
                      </div>

                      <div class="text-end meta">
                        <div class="small text-muted">${formatarData(at.data_atualizacao)}</div>
                      </div>
                    </div>

                    <div class="comentario-completo mt-3 p-2 bg-light rounded">
                      <div class="small text-muted mb-1">Comentário completo:</div>
                      <div class="comentario-texto" style="white-space:pre-wrap;">${at.comentario ?? ""}</div>
                    </div>

                    <div class="d-flex gap-2 mt-3">
                      <button class="btn btn-sm btn-outline-danger btn-remove" onclick="removerComentario('${at.id_comentario}')">Remover</button>
                    </div>
                  </div>
                </div>
                `;

              lista.appendChild(item);
            })
          });
      };


      function formatarData(d) {
        const data = new Date(d);
        return data.toLocaleDateString("pt-BR") + " " +
          data.toLocaleTimeString("pt-BR", { hour: "2-digit", minute: "2-digit" });
      }

      function removerComentario(id) {
        fetch(`http://127.0.0.1:8000/observacoes/${id}`, { method: "DELETE" })
          .then(() => carregarComentarios());
      }

      carregarComentarios();

      function logout() {
        localStorage.removeItem("usuario");
        window.location.href = "index.html";
      }
    </script>

</html>
</body>

</html>